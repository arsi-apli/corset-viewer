name: jpackage-portable

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  package:
    name: Portable ZIP (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            javafx_platform: win
          - os: macos-latest
            javafx_platform: mac
          - os: ubuntu-latest
            javafx_platform: linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Resolve versions
        shell: bash
        run: |
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"

          # jpackage wants X.Y.Z numeric; macOS requires major >= 1
          RAW=$(echo "$VERSION" | sed -E 's/[^0-9.].*$//')
          IFS='.' read -r a b c <<< "$RAW"
          a=${a:-1}; b=${b:-0}; c=${c:-0}

          if [[ "${{ matrix.os }}" == "macos-latest" && "$a" -le 0 ]]; then
            a=1
          fi

          JP_VERSION="$a.$b.$c"
          echo "JP_VERSION=$JP_VERSION" >> "$GITHUB_ENV"

          echo "Resolved Maven version: $VERSION"
          echo "Resolved jpackage version: $JP_VERSION"

      - name: Build (with platform JavaFX)
        shell: bash
        run: |
          mvn -B -DskipTests "-Djavafx.platform=${{ matrix.javafx_platform }}" clean package

      - name: Stage main jar into target/app (required by jpackage --input)
        shell: bash
        run: |
          mkdir -p target/app
          cp "target/corset-viewer-${APP_VERSION}.jar" "target/app/"

          echo "Staged files:"
          ls -la target/app
          echo "Staged libs (sample):"
          ls -la target/app/lib | head -n 50 || true

      - name: Build app-image (portable)
        shell: bash
        run: |
          APP_NAME="CorsetViewer"

          rm -rf target/jpackage
          mkdir -p target/jpackage

          jpackage \
            --type app-image \
            --dest "target/jpackage" \
            --name "$APP_NAME" \
            --app-version "${JP_VERSION}" \
            --input "target/app" \
            --main-jar "corset-viewer-${APP_VERSION}.jar" \
            --main-class "sk.arsi.corset.app.FxApp" \
            --module-path "target/app/lib" \
            --add-modules javafx.base,javafx.graphics,javafx.controls \
            --verbose

      - name: Create portable ZIP
        shell: bash
        run: |
          ZIP_NAME="corset-viewer-${JP_VERSION}-${{ matrix.javafx_platform }}.zip"
          cd target/jpackage

          if [[ "${{ runner.os }}" == "macOS" ]]; then
            APP_PATH="CorsetViewer.app"
          else
            APP_PATH="CorsetViewer"
          fi

          echo "Zipping: $APP_PATH -> ../$ZIP_NAME"
          ls -la

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            7z a "../$ZIP_NAME" "$APP_PATH"
          else
            zip -r "../$ZIP_NAME" "$APP_PATH"
          fi

          echo "Created: target/$ZIP_NAME"
          ls -la ../*.zip

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: corset-viewer-${{ matrix.javafx_platform }}-portable
          path: target/*.zip
          if-no-files-found: error

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            target/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}